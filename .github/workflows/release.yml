name: ðŸš€
on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
    branches: [main]
    paths:
      - 'repo.json'
      - 'kdl.**'
      - '**.lua'
  pull_request:
    paths:
      - 'repo.json'
      - 'kdl.**'
      - '**.lua'
  workflow_dispatch:

jobs:
  package:
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@ab6bcb2d5af0e904d04aea750e2089e9dc4cbfdd # v13
      - uses: DeterminateSystems/magic-nix-cache-action@b46e247b898aa56e6d2d2e728dc6df6c84fdb738 # v7
      - run: nix develop --command task package
      - name: Upload minimum files as an artifact
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          if-no-files-found: 'error'
          name: 'plugins'
          # Do not archive raw files with this action for splitting jobs for different triggers and displaying
          # This intentionally mades nested zip as `plgins(.zip)/micro-kdl.zip`. Cannot flatten with the upload-artifact restriction
          path: |
            micro-kdl.zip
  release:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    needs: [package]
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      # Required to checkout for gh command
      - uses: actions/checkout@v4
      - run: |
          gh run download
          tree plugins
      - name: Wait other jobs
        uses: kachick/wait-other-jobs@v3
        timeout-minutes: 15
      - run: |
          gh release create --verify-tag "$GITHUB_REF_NAME" --title "$GITHUB_REF_NAME" ./plugins/micro-kdl.zip
