name: ðŸš€
on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
    branches: [main]
    paths:
      - 'repo.json'
      - 'kdl.**'
      - '**.lua'
  pull_request:
    paths:
      - 'repo.json'
      - 'kdl.**'
      - '**.lua'
  workflow_dispatch:

jobs:
  package:
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6
      - uses: cachix/install-nix-action@2126ae7fc54c9df00dd18f7f18754393182c73cd # v31.9.1
        with:
          extra_nix_config: |
            sandbox = true
            accept-flake-config = true
      - run: nix develop --command task package
      - name: Upload minimum files as an artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          if-no-files-found: 'error'
          name: 'plugins'
          # Do not archive raw files with this action for splitting jobs for different triggers and displaying
          # This intentionally mades nested zip as `plgins(.zip)/micro-kdl.zip`. Cannot flatten with the upload-artifact restriction
          path: |
            micro-kdl.zip
  release:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    needs: [package]
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      # Required to checkout for gh command
      - uses: actions/checkout@v6
      - run: |
          gh run download '${{ github.run_id }}'
          tree plugins
      - name: Wait other jobs
        uses: kachick/wait-other-jobs@v4
        timeout-minutes: 15
      - run: |
          gh release create --verify-tag "$GITHUB_REF_NAME" --title "$GITHUB_REF_NAME" ./plugins/micro-kdl.zip
